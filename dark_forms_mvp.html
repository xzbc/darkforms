<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DarkForms :: Форум</title>
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'VT323', monospace;
      background: #000;
      color: #00ffff;
      background-image: radial-gradient(circle, #001111 0%, #000000 100%);
      position: relative;
      overflow-x: hidden;
      z-index: 0;
    }
    /* Фоновая гифка вместо шума */
    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      pointer-events: none;
      background: url('IMG/back.gif') center center / cover no-repeat;
      opacity: 0.2; /* прозрачность, чтобы текст не терялся */
      z-index: -1;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
      z-index: 1;
    }
    h1 {
      text-align: center;
      font-size: 28px;
      text-shadow: 0 0 4px #00ffff, 0 0 10px #00ffff;
      margin-bottom: 30px;
      border-bottom: 2px solid #00ffff;
      padding-bottom: 10px;
    }
    .thread-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 40px;
    }
    .thread-table th,
    .thread-table td {
      border: 1px solid #00ffff;
      padding: 10px;
      text-align: left;
    }
    .thread-table th {
      background-color: #002222;
    }
    .thread-title {
      color: #00ffff;
      text-decoration: underline;
      cursor: pointer;
    }
    .form-block {
      background-color: #001111;
      border: 1px solid #00ffff;
      padding: 20px;
      margin-bottom: 30px;
    }
    input,
    textarea,
    select,
    button {
      font-family: 'VT323', monospace;
      font-size: 16px;
      width: 100%;
      padding: 10px;
      background-color: #000;
      color: #00ffff;
      border: 1px solid #00ffff;
      margin-top: 10px;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
      min-height: 100px;
    }
    button:hover {
      background-color: #00ffff;
      color: #000;
    }
    .post-view {
      margin-top: 30px;
    }
    .post {
      border: 1px solid #00ffff;
      background-color: #001111;
      padding: 15px;
      margin-bottom: 10px;
      position: relative;
    }
    .meta {
      font-size: 14px;
      color: #77ffff;
      margin-bottom: 5px;
    }
    .reactions {
      margin-top: 10px;
    }
    .reaction-btn {
      background: none;
      color: #00ffff;
      border: 1px solid #00ffff;
      font-size: 14px;
      padding: 4px 8px;
      margin-right: 6px;
      cursor: pointer;
    }
    .reaction-btn.active {
      background-color: #00ffff;
      color: #000;
    }
    .admin-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #ff4c4c;
      border: none;
      border-radius: 3px;
      color: white;
      font-size: 12px;
      padding: 4px 8px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      z-index: 10;
    }
    .admin-btn:hover {
      background: #ff1a1a;
    }
    .back-btn {
      margin-bottom: 20px;
    }
    .post-image {
      display: block;
      max-width: 100%;
      margin: 10px auto;
      border: 1px solid #00ffff;
    }
    /* Модальное окно доступа */
    #accessBlock {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #000a;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    #accessBlock > div {
      background: #001111;
      padding: 20px;
      border: 1px solid #00ffff;
      text-align: center;
      width: 300px;
    }
    #accessBlock h2 {
      color: #00ffff;
      margin-bottom: 15px;
    }
    #accessKeyInput {
      width: 100%;
      padding: 8px;
      font-family: 'VT323', monospace;
      font-size: 18px;
      color: #00ffff;
      background: #000;
      border: 1px solid #00ffff;
      box-sizing: border-box;
    }
    #accessBlock button {
      margin-top: 10px;
      width: 100%;
      padding: 10px;
      font-family: 'VT323', monospace;
      font-size: 18px;
      cursor: pointer;
      background: #00ffff;
      color: #000;
      border: none;
    }
    #accessError {
      color: #ff4444;
      margin-top: 10px;
      display: none;
    }
  </style>
</head>
<body>
  <!-- Модальное окно для ключа доступа -->
  <div id="accessBlock">
    <div>
      <h2>Введите секретный ключ доступа</h2>
      <input type="password" id="accessKeyInput" placeholder="Ключ доступа" />
      <button onclick="checkAccessKey()">Войти</button>
      <p id="accessError">Неверный ключ</p>
    </div>
  </div>

  <div class="container" id="mainContent" style="display:none;">
    <h1>darkforms</h1>

    <div class="form-block">
      <label for="category">Категория:</label>
      <select id="category">
        <option value="Работа">Работа</option>
        <option value="Семья">Семья</option>
        <option value="Отношения">Отношения</option>
        <option value="Трешстори">Трешстори</option>
        <option value="Нытьё">Нытьё</option>
      </select>
      <label for="newTitle">Заголовок темы:</label>
      <input type="text" id="newTitle" placeholder="Заголовок темы" />
      <textarea id="newMessage" rows="4" placeholder="Первое сообщение..."></textarea>
      <input type="file" id="imageUpload" accept="image/*" />
      <button onclick="createThread()">Создать тему</button>
    </div>

    <table class="thread-table" id="threadList">
      <thead>
        <tr>
          <th>Категория</th>
          <th>Тема</th>
          <th>Ответов</th>
          <th>Дата</th>
        </tr>
      </thead>
      <tbody id="threadRows"></tbody>
    </table>

    <div class="post-view" id="threadView" style="display: none">
      <button class="back-btn" onclick="goBack()">← Назад к списку тем</button>
      <h2 id="viewTitle"></h2>
      <div id="postContainer"></div>
      <textarea id="replyInput" rows="3" placeholder="Ваш ответ..."></textarea>
      <button onclick="addReply()">Ответить</button>
    </div>
  </div>

  <script>
    let oneTimeKeys = [];

    async function loadKeys() {
      try {
        const res = await fetch('keys.json');
        if (!res.ok) throw new Error('Ошибка загрузки keys.json');
        oneTimeKeys = await res.json();
        saveKeys();
      } catch (e) {
        console.error(e);
        // Если ошибка — дефолтные ключи
        oneTimeKeys = ['key123', 'key456', 'key789'];
      }
    }

    function saveKeys() {
      localStorage.setItem('darkforms_oneTimeKeys', JSON.stringify(oneTimeKeys));
    }

    window.addEventListener('DOMContentLoaded', async () => {
      if (!localStorage.getItem('darkforms_oneTimeKeys')) {
        await loadKeys();
      } else {
        oneTimeKeys = JSON.parse(localStorage.getItem('darkforms_oneTimeKeys'));
      }

      if (localStorage.getItem('darkforms_access_granted')) {
        document.getElementById('accessBlock').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
      }

      renderThreads();
      checkAdmin();
    });

    function checkAccessKey() {
      const input = document.getElementById('accessKeyInput').value.trim();
      const error = document.getElementById('accessError');
      if (oneTimeKeys.includes(input)) {
        oneTimeKeys = oneTimeKeys.filter(k => k !== input);
        saveKeys();

        localStorage.setItem('darkforms_access_granted', input);

        document.getElementById('accessBlock').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        error.style.display = 'none';
      } else {
        error.style.display = 'block';
      }
    }

    // === Админка ===
    let isAdmin = false;
    const ADMIN_PASSWORD = '5640512qw12qw';

    function checkAdmin() {
      if (localStorage.getItem('darkforms_isAdmin') === 'true') {
        isAdmin = true;
      } else if (window.location.hash === '#admin') {
        const pwd = prompt('Введите пароль администратора:');
        if (pwd === ADMIN_PASSWORD) {
          isAdmin = true;
          localStorage.setItem('darkforms_isAdmin', 'true');
          alert('Доступ администратора активирован!');
        } else {
          alert('Неверный пароль, доступ запрещён');
          history.replaceState(null, '', window.location.pathname);
        }
      }
    }

    let threads = JSON.parse(localStorage.getItem('darkforms_threads')) || [];
    let currentThreadIndex = null;
    const userReactions = JSON.parse(localStorage.getItem('darkforms_reactions') || '{}');

    function saveThreads() {
      localStorage.setItem('darkforms_threads', JSON.stringify(threads));
    }

    function saveReactions() {
      localStorage.setItem('darkforms_reactions', JSON.stringify(userReactions));
    }

    function renderThreads() {
      const rows = document.getElementById('threadRows');
      rows.innerHTML = '';
      threads.forEach((t, i) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${t.category}</td>
          <td><span class="thread-title" onclick="openThread(${i})">${t.title}</span></td>
          <td>${t.messages.length}</td>
          <td>${t.date}</td>
        `;
        rows.appendChild(row);
      });
    }

    function createThread() {
      const title = document.getElementById('newTitle').value.trim();
      const msg = document.getElementById('newMessage').value.trim();
      const category = document.getElementById('category').value;
      const imageFile = document.getElementById('imageUpload').files[0];
      if (!title || !msg) return;
      const now = new Date().toLocaleString();
      if (imageFile) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const imageData = e.target.result;
          threads.push({
            category,
            title,
            date: now,
            messages: [{ text: msg, date: now, reactions: { like: 0, dislike: 0 }, image: imageData }],
          });
          saveThreads();
          renderThreads();
        };
        reader.readAsDataURL(imageFile);
      } else {
        threads.push({
          category,
          title,
          date: now,
          messages: [{ text: msg, date: now, reactions: { like: 0, dislike: 0 } }],
        });
        saveThreads();
        renderThreads();
      }
      document.getElementById('newTitle').value = '';
      document.getElementById('newMessage').value = '';
      document.getElementById('imageUpload').value = '';
    }

    function openThread(i) {
      currentThreadIndex = i;
      const thread = threads[i];
      document.getElementById('viewTitle').textContent = thread.title;
      const container = document.getElementById('postContainer');
      container.innerHTML = '';
      thread.messages.forEach((msg, idx) => {
        const div = document.createElement('div');
        div.className = 'post';
        const userKey = `${currentThreadIndex}_${idx}`;
        const userReaction = userReactions[userKey];
        div.innerHTML = `
          <div class="meta">anon :: ${msg.date}</div>
          ${msg.image ? `<img src="${msg.image}" class="post-image">` : ''}
          <div>${msg.text}</div>
          <div class="reactions">
            <button class="reaction-btn ${
              userReaction === 'like' ? 'active' : ''
            }" onclick="react(${idx}, 'like')">❤️ ${msg.reactions?.like || 0}</button>
            <button class="reaction-btn ${
              userReaction === 'dislike' ? 'active' : ''
            }" onclick="react(${idx}, 'dislike')">💔 ${msg.reactions?.dislike || 0}</button>
          </div>
        `;
        if (isAdmin) {
          const delBtn = document.createElement('button');
          delBtn.textContent = 'Удалить';
          delBtn.className = 'admin-btn';
          delBtn.onclick = () => deletePost(idx);
          div.appendChild(delBtn);
        }
        container.appendChild(div);
      });
      document.getElementById('threadList').style.display = 'none';
      document.getElementById('threadView').style.display = 'block';
    }

    function deletePost(index) {
      if (confirm('Удалить сообщение?')) {
        threads[currentThreadIndex].messages.splice(index, 1);
        if (threads[currentThreadIndex].messages.length === 0) {
          // Удаляем тему если пустая
          threads.splice(currentThreadIndex, 1);
          saveThreads();
          goBack();
        } else {
          saveThreads();
          openThread(currentThreadIndex);
        }
      }
    }

    function goBack() {
      document.getElementById('threadView').style.display = 'none';
      document.getElementById('threadList').style.display = 'table';
      renderThreads();
    }

    function addReply() {
      const text = document.getElementById('replyInput').value.trim();
      if (!text) return;
      const now = new Date().toLocaleString();
      threads[currentThreadIndex].messages.push({ text, date: now, reactions: { like: 0, dislike: 0 } });
      saveThreads();
      openThread(currentThreadIndex);
      document.getElementById('replyInput').value = '';
    }

    function react(index, type) {
      const userKey = `${currentThreadIndex}_${index}`;
      const msg = threads[currentThreadIndex].messages[index];
      if (!msg.reactions) msg.reactions = { like: 0, dislike: 0 };
      const previous = userReactions[userKey];
      if (previous && previous !== type) {
        msg.reactions[previous]--;
        msg.reactions[type]++;
        userReactions[userKey] = type;
      } else if (!previous) {
        msg.reactions[type]++;
        userReactions[userKey] = type;
      }
      saveThreads();
      saveReactions();
      openThread(currentThreadIndex);
    }
  </script>
</body>
</html>
